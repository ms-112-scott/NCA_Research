# 程式碼重構計畫 (2025-09-21)

本文件旨在解決目前專案中程式碼結構混亂的問題，並提出一個清晰、可執行的重構方案。

---

### 當前問題

目前的功能函式定義分散在三個地方，職責不清：
1.  **Jupyter Notebooks**: 包含大量一次性的、或可重複使用的輔助函式，與實驗主流程混雜。
2.  **`E4_PI_NCA/utils/`**: 包含部分為 E4 實驗服務的工具，但與 Notebooks 中的函式存在職責重疊。
3.  **`core_utils/`**: 包含專案級的通用工具，但其邊界有時不清晰。

這種結構導致程式碼難以維護、複用和除錯。

---

### 重構目標

我們的目標是建立一個清晰的層級結構，讓每一部分程式碼的職責單一化：

- **`core_utils/`**: **專案級通用工具箱**。包含任何實驗都可能用到的、與特定物理問題無關的基礎函式（如：圖片儲存、影片寫入、基礎繪圖等）。
- **`E4_PI_NCA/utils/`**: **E4 實驗專用工具箱**。包含專為 E4 實驗設計的、與 CFD/LBM/PINN 問題緊密相關的函式（如：特定資料的預處理、物理損失的計算、樣本池管理等）。
- **Jupyter Notebooks (`.ipynb`)**: **高階實驗腳本**。只負責串聯、配置和執行實驗流程，所有底層功能都從上述 `utils` 目錄中導入。

---

### 重構執行藍圖

我建議採用漸進式、分步驟的方式進行重構。

#### 步驟一：建立 E4 專屬的核心工具檔案

1.  在 `E4_PI_NCA/utils/` 目錄下，建立一個新的 Python 檔案，命名為 `E4_utils.py`。
2.  這個檔案將作為 E4 實驗相關輔助函式的集中存放地。

#### 步驟二：從單一 Notebook 開始，遷移函式

我們以 `E4-1.0_Data_Visualization.ipynb` 作為第一個重構對象。

1.  **識別與遷移**: 
    *   識別出該筆記本中定義的 `get_wall_mask_via_tf` 函式。
    *   將這個函式的完整程式碼（包含其內部的 `import` 需求，如 `numpy` 和 `tensorflow`）剪下，並貼上到 `E4_PI_NCA/utils/E4_utils.py` 中。

2.  **修改原 Notebook**: 
    *   刪除原筆記本中定義 `get_wall_mask_via_tf` 的儲存格。
    *   在筆記本最上方的導入區域，新增一行程式碼：
        ```python
        from E4_PI_NCA.utils.E4_utils import get_wall_mask_via_tf
        ```
    *   為了讓 Python 能夠找到這個新模組，可能還需要在設定 `project_root` 的程式碼塊中，確保 `E4_PI_NCA` 的父目錄（即 `NCA_Research`）在 `sys.path` 中。

3.  **驗證**: 重新執行該筆記本，確保在導入函式後，所有功能依然正常運作。

#### 步驟三：逐步推廣至所有 Notebooks

1.  在成功重構第一個筆記本後，我將依照新的檔案編號順序 (`E4-1.1`, `E4-2.0`, ...)，依次檢查每一個筆記本。
2.  識別其中所有「可複用的」或「功能性的」輔助函式，並將它們遷移到 `E4_utils.py`（如果與 E4 實驗相關）或 `core_utils` 的相應檔案中（如果非常通用）。
3.  在遷移後，修改筆記本，將函式定義替換為 `import` 語句。

#### 步驟四：審查與合併 `utils` 檔案

在所有筆記本都清理完畢後，我們可能會發現 `E4_PI_NCA/utils/` 目錄下的 `helper.py` 中的部分功能已經被 `E4_utils.py` 覆蓋，或者可以合併。屆時可以對 `utils` 目錄進行最終的整理，確保沒有重複或廢棄的程式碼。

---

### 預期成果

完成重構後，專案結構將變得極為清晰：
- **開發新實驗**: 你可以複製一個現有的 Notebook，只需修改頂層的配置和流程，而無需關心底層函式的實現。
- **修改工具函式**: 當你需要改進某個功能（例如，一個新的繪圖樣式或一個優化過的損失計算）時，只需在對應的 `utils` 檔案中修改一次，所有依賴它的實驗都會自動更新。
- **程式碼可讀性**: Notebooks 將只包含高階邏輯，讓人能一眼看懂實驗的核心思想與步驟。

如果同意此計畫，我將從**步驟一**和**步驟二**開始執行。
