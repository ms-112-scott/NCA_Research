# 設計物理資訊神經細胞自動機 (PINN-NCA)

## 1. 核心理念：將物理定律融入學習

物理資訊神經網絡 (Physics-Informed Neural Networks, PINN) 的核心思想是將物理定律（通常以偏微分方程 PDE 的形式表示）作為一個歸納偏置（inductive bias）整合到神經網絡的損失函數中。

這強迫神經網絡在學習數據分佈的同時，其預測結果也必須嚴格遵守指定的物理定律，從而提高模型的泛化能力和物理真實感。

## 2. 物理模型：二維不可壓縮流之 Navier-Stokes (N-S) 方程

我們的目標是模擬流體動力學，其控制方程為 Navier-Stokes (N-S) 方程。對於二維不可壓縮流，此方程可分解為**連續性方程**和**動量方程**。

-   **連續性方程 (質量守恆):**
    $$ \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y} = 0 $$

-   **x-動量方程:**
    $$ \frac{\partial u}{\partial t} + u \frac{\partial u}{\partial x} + v \frac{\partial u}{\partial y} = - \frac{1}{\rho} \frac{\partial p}{\partial x} + \nu \left( \frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial y^2} \right) $$

-   **y-動量方程:**
    $$ \frac{\partial v}{\partial t} + u \frac{\partial v}{\partial x} + v \frac{\partial v}{\partial y} = - \frac{1}{\rho} \frac{\partial p}{\partial y} + \nu \left( \frac{\partial^2 v}{\partial x^2} + \frac{\partial^2 v}{\partial y^2} \right) $$

**符號定義:**
-   $u$: x 方向速度
-   $v$: y 方向速度
-   $p$: 壓力
-   $ho$: 流體密度 (對於不可壓縮流，視為常數)
-   $
u$: 運動粘度

## 3. 損失函數設計：結合數據與物理

為了將 N-S 方程整合進 NCA 的學習過程，我們設計一個由**數據損失**和**物理損失**組成的複合損失函數。

### 3.1. 物理殘差 (Physics Residual)

首先，我們將 N-S 方程移項，使其右側為 0。這些方程的計算結果被稱為**物理殘差**。一個完美的物理模型，其殘差應處處為零。

-   **質量守恆殘差 ($f_{mass}$):**
    $$ f_{mass} = \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y} $$

-   **x-動量殘差 ($f_{mom_x}$):**
    $$ f_{mom_x} = \frac{\partial u}{\partial t} + u \frac{\partial u}{\partial x} + v \frac{\partial u}{\partial y} + \frac{1}{\rho} \frac{\partial p}{\partial x} - \nu \left( \frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial y^2} \right) $$

-   **y-動量殘差 ($f_{mom_y}$):**
    $$ f_{mom_y} = \frac{\partial v}{\partial t} + u \frac{\partial v}{\partial x} + v \frac{\partial v}{\partial y} + \frac{1}{\rho} \frac{\partial p}{\partial y} - \nu \left( \frac{\partial^2 v}{\partial x^2} + \frac{\partial^2 v}{\partial y^2} \right) $$

### 3.2. 數值微分：有限差分法

由於 NCA 的輸出是離散的網格數據，我們需要使用數值方法（如**有限差分法**）來近似計算偏導數。例如，使用中心差分計算 $\frac{\partial u}{\partial x}$:

$$ \frac{\partial u}{\partial x} \approx \frac{u(x+\Delta x, y) - u(x-\Delta x, y)}{2\Delta x} $$

所有其他的一階和二階偏導數（包括對時間的導數 $\frac{\partial u}{\partial t}$）都可以用類似的方法計算。這可以通過卷積操作高效實現。

### 3.3. 總損失函數

總損失函數 $L_{total}$ 是傳統數據損失 $L_{data}$ 和物理損失 $L_{physics}$ 的加權和。

$$ L_{total} = L_{data} + \lambda \cdot L_{physics} $$

-   **數據損失 ($L_{data}$):**
    衡量 NCA 預測的下一幀與真實 CFD 數據之間的差異，通常使用均方誤差 (MSE)。
    $$ L_{data} = \text{MSE}(\text{NCA}_{\text{output}}, \text{Ground Truth}) $$

-   **物理損失 ($L_{physics}$):**
    物理殘差的均方誤差，驅使模型遵守物理定律。
    $$ L_{physics} = \text{MSE}(f_{mass}, 0) + \text{MSE}(f_{mom_x}, 0) + \text{MSE}(f_{mom_y}, 0) $$

-   **權重 ($\lambda$):**
    一個關鍵的超參數，用於平衡數據擬合與物理約束的重要性。

## 4. 挑戰與實施策略

1.  **壓力場 `p` 的處理:**
    NCA 模型本身不直接輸出壓力 `p`。
    -   **策略 A (通道擴展):** 增加 NCA 的輸出通道，使其直接預測壓力場 `p`。這是最直接的方法。
    -   **策略 B (壓力泊松方程):** 從速度場反解壓力，計算複雜度高。
    -   **策略 C (忽略壓力):** 僅適用於極低速流動，會犧牲準確性。

2.  **邊界條件 (Boundary Conditions):**
    必須在損失函數中明確地強制執行邊界條件。例如，在固體牆壁處，流體速度應為零（無滑 slip 條件）。

3.  **計算效率:**
    高階導數的計算非常耗費資源。可以利用 PyTorch 的 `autograd` 機制或設計專用的卷積核來高效實現有限差分，以優化計算性能。

4.  **超參數 $\lambda$ 的選擇:**
    $\lambda$ 的值需要通過實驗仔細調整。過大會導致模型忽略數據細節，過小則物理約束失效。

## 5. 下一步行動計畫

1.  **實現數值微分模塊:** 開發一個使用 PyTorch 卷積層高效計算偏導數的模塊。
2.  **擴展 NCA 輸出:** 修改 NCA 模型，增加一個用於預測壓力 `p` 的輸出通道。
3.  **構建複合損失函數:** 在訓練腳本中實現 $L_{total}$ 的計算邏輯。
4.  **實驗與調優:** 系統性地進行實驗，評估物理損失的影響，並尋找最佳的超參數 $\lambda$。
